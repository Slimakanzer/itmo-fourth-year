# Лабораторная работа 2

**Название:** "Разработка драйверов блочных устройств"

**Цель работы:** Получить знания и навыки разработки драйверов блочных устройств для операционной системы Linux. 

**Выполнили:** Ларочкин Глеб игоревич PЗ400, Шуст Иван Владимирович P3400

## Описание функциональности драйвера

Драйвер создает:
* Первичный раздел размером 20 Мбайт
* Расширенный раздел, содержащий три логических раздела 10 Мбайт
* Разметка с помощью MBR

## Инструкция по сборке

1. Перейдите в директортю `io-systems/lab2`
2. Соберите программу: `make`
3. Добавляем драйвер в ядро. В директории `/dev` будет 5 девайсов _var5pN_, где _N_ - номер раздела:
    > insmod var5.ko
4. Создаем файловые системы на девайсах: 
    > mkfs.vfat -F16 /dev/var5p1 && mkfs.vfat -F16 /dev/var5p5
5. Монтируем их в точки монтирования: 
    > mkdir -p /mnt/var5p1 /mnt/var5p5 && mount /dev/var5p1 /mnt/var5p1 && mount /dev/var5p5 /mnt/var5p5

## Примеры использования

Проверка точки монтирования
```bash
$ mount -l | grep "/dev/var5"
```

Размонтирование файловых систем и деинициализация драйвера:
```bash
$ umount /dev/var5p1 && umount /dev/var5p5
$ rmmod var5
```

Проверка сообщений в кольцевом буфере
```bash
$ cd /mnt/var5p1
$ touch example
$ dmesg
...
[var5]: Sector: 6035, Sector Offset: 0; Buffer: 00000002989b254; Length: 8 sectors
```

Создание файлов на виртуальном устройстве
```bash
$ cd /mnt/var5p1
$ echo "Hello block device" > ./hello
```

## Профилирование скорости копирования

Измерение скорости передачи данных при копировании файлов между разделами виртуального диска
```bash
$ fallocate -l 7340032 /mnt/var5p1/example.txt              # создание файла 7Мбайт
$ pv -pr /mnt/var5p1/example.txt > /mnt/var5p5/example.txt  # копирование файла из виртуального раздела 1 в логический виртуальный раздел 5
```

Измерение скорости передачи данных при копировании файлов между разделами виртуального диска
```bash
$ fallocate -l 7340032 /mnt/example.txt              # создание файла 7Мбайт
$ pv -pr /mnt/example.txt > /mnt/var5p1/example.txt  # копирование файла из реального диска в виртуальный диск
```

размер (Mbyte) | количество тестов | с реального на виртуальный (Mbit/s) | с виртуального на виртуальный (Mbit/s)
-------------- | ----------------- | ----------------------------------- | --------------------------------------
7 | 10 | 373 | 431
5 | 10 | 308 | 416
3 | 10 | 452 | 507
